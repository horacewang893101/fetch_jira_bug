# MP-393: CSP not fully hardened – use of 'unsafe-inline' and 'unsafe-eval' weakens XSS protection

**Status:** Backlog

**Assignee:** Unassigned

**Description:**
*Initial assumptions:*

* Logged in as user: {{krzysztof.dolecki}} on: {{https://trial.aicentral.top/?mode=default}}
* The application uses a Content Security Policy (CSP) header to control which resources can be loaded and how the UI can be embedded.
* The following response headers are observed on main UI or chatbot-related API responses (representative sample):

HTTP/1.1 200 OK
Content-Type: application/json
content-security-policy: default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; font-src 'self' data:; connect-src 'self' [https://*.microsoftonline.com|https://*.microsoftonline.com] ws: wss: blob:; media-src 'self' blob:; object-src 'none'; child-src 'self'; frame-ancestors 'self' [https://teams.microsoft.com|https://teams.microsoft.com]
x-content-type-options: nosniff
x-frame-options: SAMEORIGIN
x-xss-protection: 1; mode=block
strict-transport-security: max-age=31536000; includeSubDomains
referrer-policy: no-referrer
permissions-policy: geolocation=(self), microphone=()
expect-ct: max-age=86400, enforce
cache-control: no-store

* CSP configuration is evaluated in the scope of OWASP Configuration & Deployment Security Checks, specifically TC-CFG-03 – Content Security Policy (CSP) Hardening and OWASP guidance (e.g. CSP Cheat Sheet, WSTG).

*Steps:*

# Open the application in a browser and navigate to a page where the main UI and embedded chatbot are loaded (e.g. primary dashboard or chatbot view).
# Open browser DevTools → Network.
# Refresh the page to capture a fresh set of network requests.
# Select the main document request (or a representative API response that carries global security headers).
# Inspect the response headers and locate the content-security-policy header.
# Review the CSP directives, with a focus on script-src and style-src.

*Current result:*

* The CSP header is present and partially restrictive, but it allows unsafe inline JavaScript, unsafe evaluation, and inline CSS through the following directives:
** script-src 'self' 'unsafe-inline' 'unsafe-eval';
style-src 'self' 'unsafe-inline';
* This configuration:
** Allows inline JavaScript execution (e.g. <script> blocks in HTML, inline event handlers such as onclick/onload).
** Allows eval-like constructs and similar dynamic code evaluation (e.g. eval, new Function()) via 'unsafe-eval'.
** Allows inline CSS, which may support style-based attack patterns or complicate future CSP hardening.
** As a result, CSP provides only limited protection against XSS and browser-based injection attacks. If an attacker manages to inject inline script or data reaching eval, the current CSP will not reliably block execution.

*Expected results:*

# The CSP should be hardened in line with OWASP recommendations for modern web applications, particularly for a UI that accepts user input through an embedded chatbot. Specifically:
## script-src should not rely on 'unsafe-inline' and 'unsafe-eval'. Instead, inline scripts should be eliminated or protected via nonces or hashes, and eval-like constructs should be removed from the codebase.
## style-src should avoid 'unsafe-inline' wherever feasible by moving inline styles into external stylesheets or, if absolutely necessary, using CSP hashes for specific, controlled inline style blocks.
# The target state should look closer to:
## content-security-policy: default-src 'self'; script-src 'self' <nonces and/or hashes only>; style-src 'self' <hashes or controlled exceptions>; img-src 'self' data: blob:; font-src 'self' data:; connect-src 'self' [https://*.microsoftonline.com|https://*.microsoftonline.com] ws: wss: blob:; media-src 'self' blob:; object-src 'none'; frame-ancestors 'self' [https://teams.microsoft.com;|https://teams.microsoft.com;] ...
# CSP should act as a strong second line of defense against XSS, not just a partial control that still permits unsafe inline and eval usage.

*Impact / Risk:*

Security risk – weakened protection against XSS and injection:

Because 'unsafe-inline' and 'unsafe-eval' are allowed, successful injection of inline script, event handlers, or data reaching eval can still result in arbitrary JavaScript execution in the user’s browser.

CSP, which OWASP positions as an important mitigation for XSS and related attacks, is not operating at its full defensive potential.

Non-alignment with OWASP best practices:

OWASP CSP guidance explicitly recommends avoiding 'unsafe-inline' and 'unsafe-eval' in script-src and minimizing 'unsafe-inline' in style-src.

The current configuration is better than having no CSP at all, but it does not meet hardening expectations for applications that process user input and potentially sensitive data through a chatbot interface.

*Suggestions / Recommendations:*

* Refactor inline JavaScript where feasible and gradually remove 'unsafe-inline' from script-src.
* Refactor inline styles where feasible and gradually remove 'unsafe-inline' from style-src.
* Use CSP nonces or hashes for any remaining, necessary inline scripts/styles.
* Remove 'unsafe-eval' by eliminating eval-like constructs (e.g. eval, new Function) and then dropping 'unsafe-eval' from script-src.
* Apply CSP changes iteratively (test/staging → production) and align the final policy with OWASP CSP guidance.
